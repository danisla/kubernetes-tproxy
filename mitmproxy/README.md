# Mitmproxy Chart

Mitmproxy is an interactive man-in-the-middle proxy for HTTP and HTTPS with a console interface and Python scripting. 

This chart uses `mitmdump` the command-line version of mitmproxy, which is similar to tcpdump for HTTP.

When combinded with iptables REDIRECT rules, mitmproxy can also be used as a transparent proxy, similar to [squid](http://www.squid-cache.org/) to force all HTTP traffic through the proxy regardless of client configuration.

The scripting capabilities of mitmproxy lets you programatically intercept and inspect HTTP and HTTPS traffic using the Python.

## Installing the Chart

Before installing the chart, you must first get the certificates generated by mitmproxy. The generated CA cert will be used in the target pods to trust the proxy when making HTTPS requests.

```sh
docker run --rm -v ${PWD}/certs/:/home/mitmproxy/.mitmproxy mitmproxy/mitmproxy >/dev/null 2>&1
```

> This will install the certs to the `./certs` directory where they will be referenced by Helm.

Install the helm chart:

```
helm install -n tproxy .
```

### Using with deployments

Add this metadata annotation to your deployment spec:

```yaml
metadata:
  annotations:
    "initializer.kubernetes.io/tproxy": "true"
```

This will cause the `tproxy-initializer` to do the following:

- Inject the tproxy sidecar container into the pod.
- Adds default environment variables `http_proxy` and `https_proxy` that point to the mitmproxy daemonset on the same node as the pod.
- Inject the CA cert bundle with the mitmproxy CA cert to the following paths:

```
# Fedora/Redhat/CentOS
/etc/pki/tls/certs/ca-bundle.crt

# Debian/Ubuntu
/etc/ssl/certs/ca-certificates.crt
```

### Customizing the mitmproxy script

To change the mitmproxy script do the following:

1. Edit the `./config/mitm-script.py` file.
3. Upgrade the Helm release. `helm upgrade tproxy .`

After about 30 seconds, the new script will be live-updated and in use by mitmproxy. 

## Configuration

The following table lists the configurable parameters for the chart and their default values.

| Parameter                            | Description                                                              | Default                                    |
| ------------------------------------ | ------------------------------------------------------------------------ | ------------------------------------------ |
| `images.tproxy_registry`             | Container image registry for the `tproxy-` images                        | `docker.io/danisla`                        |
| `images.pullPolicy`                  | The image pull policy for all images                                     | `IfNotPresent`                             |
| `images.tproxy_initializer`          | repo and tag for the tproxy-initializer image                            | `tproxy-initializer:0.1.0`                 |
| `images.tproxy_podwatch`             | repo and tag for the tproxy-podwatch image                               | `tproxy-podwatch:0.1.0`                    |
| `images.tproxy_sidecar`              | repo and tag for the tproxy-sidecar image                                | `tproxy-sidecar:0.1.0`                     |
| `tproxy.useRBAC`                     | Enable installation of RBAC serviceacount, roles, and bindings, set to `false` if using legacy authorization | `true` |
| `tproxy.useInitializer`              | Enable initializer. Set to `false` if `admissionregistration.k8s.io/v1alpha1` is not enabled | `true`                 |
| `tproxy.hostPort`                    | The port claimed on each host node that mitmproxy binds to               | `8080`                                     |
| `tproxy.addStandardModeProxy`        | Set to `true` to install a second mitmproxy instance on port `1080` that can be used as a normal proxy | `false`      |
| `tproxy.resources`                   | Resources allocated to the mitmproxy containers                          | `limit=500m,256Mi, request=100m,128Mi`     |
